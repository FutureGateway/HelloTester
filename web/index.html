<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>HelloTester</title>
        <!-- Bootstrap -->
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="js/jquery.min.js"></script>
        <script src="js/bootstrap.min.js"></script>        
        <script src="js/jquery.tablesorter.mod.js"></script>          
    </head>
    <body>
        
        <script type="text/javascript"> 
            function addJobRecord(i,jrec) {
                job_status      = jrec.status;
                job_date        = jrec.date;
                job_description = jrec.description;
                out_files       = jrec.output_files;
                
                var OutFiles ='';
                for (var j = 0; j < out_files.length; j++) {
                    // Show only file entries of DONE jobs
                    if(job_status != 'DONE') break;
                    OutFiles+=
                        '<div>'                       
                       +'<a href="http://localhost:7777/v1.0/'
                       +out_files[j].url+'">'
                       +out_files[j].name+'</a>'
                       +'</div>';
                }                
                TableRow= 
                     '<tr>'
                    +'   <td rowspan="2">'
                    +'        <button id="job_btn'+i+'" class="btn btn-default btn-xs toggle">'
                    +'        <span class="glyphicon glyphicon-eye-open"></span>'
                    +'        </button>'
		    +'	</td>'
		    +'  <td>'+job_date+'</td>'
		    +'	<td>'+job_status+'</td>'
		    +'	<td>'+job_description+'</td>'			
                    +'</tr>'
                    +'<tr class="tablesorter-childRow">' 
                    +'<td colspan="4">'
                    +'<div class="bold"><b>Output</b></div>'
                    +OutFiles
                    +'</td>'
                    +'</tr>'
                    ;                                                                      
                return TableRow;
            }
            function fillJobTable(data) {
                var tableRows='';
                for (var i = 0; i < data.length; i++) {
                    tableRows+=addJobRecord(i,data[i]);
                                        
                }
                jobsTable =
                 '<table id="jobTable" class="table table-responsive tablesorter">'
                +'	<colgroup>'
                +'		<col/>'
                +'		<col/>'
                +'		<col/>'
                +'		<col/>'	
                +'	</colgroup>'
                +'	<thead>'
                +'           <tr>'
                +'               <th></th>'
                +'                <th>Date</th>'
                +'                <th>Status</th>'
                +'                <th>Description</th>'			
                +'            </tr>'
                +'	</thead>'
                +'      <tbody id="jobRecords">'
                +tableRows
                +'      </tbody>'
                +'<tfoot style="size:0px">'
                +'</tfoot>'
                +'</table>';
                // Add table
                $('#jobsDiv').append(jobsTable);
                // Compress childs
                $('.tablesorter-childRow td').hide();
                // Sort table
                $("#jobTable").tablesorter(
                {
                    theme : 'blue',
                    sortList: [[1,1]],
                    cssChildRow: "tablesorter-childRow"
                }        
                ); 
                $('.tablesorter').delegate('.toggle', 'click' ,function(){
                    $(this).closest('tr').nextUntil('tr:not(.tablesorter-childRow)').find('td').toggle();
                    return false;
                });
                // Log data
                console.log(jobsTable);
            }            
            function prepareJobTable() {                
                $.ajax({
                    type: "GET", 
                    url: "http://localhost:7777/v1.0/tasks?user=brunor&app_id=1", 
                    dataType: "json",                    
                    success: function(data) {                                                        
                            fillJobTable(data);                            
                        }, 
                    error: function(jqXHR, textStatus, errorThrown) {
                            alert(jqXHR.status);
                        }                   
               });               
            }
            function getNumJobs() {
                return $('#jobRecords table').size();
            }
            function submit() {
                $('#submitButton').hide();
                job_failed ='<div class="alert alert-danger">'
                           +'<strong>ERROR!</strong> Failed to submit job.'
                           +'</div>';
                job_success='<div class="alert alert-success">'
                            +'<strong>Success!</strong> Job successfully sent.'
                            +'</div>';
                job_warning='<div class="alert alert-warning">'
                            +'<strong>WARNING!</strong> Unable to get job details.'
                            +'</div>';
                job_description = $('#jobDescription').val();
                $('#modal-content').html('');
                // 1st call to register job                
                $.ajax({
                    url: "http://localhost:7777/v1.0/tasks?user=brunor",
                    type: "POST", 
                    cache: false,
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify({ application: "1"
                                          , description: job_description
                                          , output_files: []                                          
                                         }),                          
                    success: function(data) {
                            // 2nd call finalize and start submission                                                        
                            $.ajax({
                                url: "http://localhost:7777/v1.0/tasks/"+data.id+"/input?user=brunor",
                                type: "POST", 
                                cache: false,
                                dataType: "json",
                                contentType: "application/json; charset=utf-8",
                                data: JSON.stringify({}),
                                success: function(data) {
                                       $('#jobTable').remove();
                                       prepareJobTable();
                                    }, 
                                error: function(jqXHR, textStatus, errorThrown) {
                                        $('#modal-content').html(job_failed);
                                        alert(jqXHR.status);
                                    }
                            });
                        }, 
                    error: function(jqXHR, textStatus, errorThrown) {
                            $('#modal-content').html(job_failed);
                            alert(jqXHR.status);
                        }                   
                });                                
            }
            function openModal() {
                var currentdate = new Date(); 
                var datetime = currentdate.getDate() + "/"
                             +(currentdate.getMonth()+1)  + "/" 
                             + currentdate.getFullYear() + " @ "  
                             + currentdate.getHours() + ":"  
                             + currentdate.getMinutes() + ":" 
                             + currentdate.getSeconds();
                $('#submitButton').show();
                $('#modal-content').html('');                
                $('#jobDescription').val('Helo tester job desc '+datetime);
                $("#helloTesterModal").modal();
            }
            // Initialize page
            $( document ).ready(function() {                
                prepareJobTable();                
            });
        </script>
        <div class="panel panel-default">
        <div class="panel-heading"><h3>HelloTester web application</h3></div>
        <div class="panel-body">
        
        <button type="button" class="btn btn-primary btn-lg" id="openmodal" onClick="openModal()">
            Launch Hello tester job
        </button>
        <hr>
        <!-- Submit record table (begin) -->    
        <div id="jobsDiv"> 
        </div>        
        
        <!-- Submit record table (end) -->
        </div>        
        </div> 
        <div class="panel-footer"><small>HelloTester</small></div>
        <!-- Modal (begin) -->
        <div class="modal fade" id="helloTesterModal" tabindex="-1" role="dialog" aria-labelledby="HelloTester">          
          <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Hello tester submission pane</h4>
              </div>
              <div class="modal-body">
                <p>Welcome to the 1st web application testing the new FutureGateway APIs.</p>
                <p>This application just execute over SSH a simple hostname command.</p>
                <p>Please press <b>'submit'</b> button to execute the 'Hello' application.</p>
                <p>Press cancel to return to the Hello' home/summary page.</p>
                <p><b>Specify your job identifier: </b>
                <input type="text" id="jobDescription" size="60"/>
                </p>
                <!-- This is not shown properly
                <div class="modal-content" id="modal-content">                                                                               
                </div>
                -->
              </div>
              <div class="modal-footer">
                <center>                
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onClick="submit()" id="submitButton">Submit</button>
                </center>
              </div>
            </div>
          </div>
        </div>   
        <!-- Modal (end) -->
    </body>    
</html>
